<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Investment Tracking</title>
        <link rel="stylesheet" th:href="@{/style.css}" />
        <link rel="stylesheet" th:href="@{/webjars/bootstrap/3.3.5/css/bootstrap.min.css}" href="bootstrap.min.css"  media="screen" />        
    </head>
    <body>        
        <div class="col-md-2">
            <div id="wrapper">               
                <div th:replace="common :: leftnav"></div>          
            </div>
        </div>
        <div class="col-md-5">
        <h1 th:text="${investment.name}">Investment</h1>
            <p th:text="${investment.description}"></p>
            
            <dl id="definitions" class="dl-horizontal">                    
            <dt>Value proposition</dt>
            <dd th:text="${investment.valueProposition}">value proposition</dd>
            <dt>Desirability proposition</dt>
            <dd th:text="${investment.desirabilityStatement}">desirabilityStatement</dd>                    
            <dt>Initial investment(£)</dt>
            <dd th:text="${investment.initialInvestment}">Initial investment</dd>
            <dt>Value(£)</dt>
            <dd th:text="${investment.value}">Value</dd>
            </dl>
        </div>
        <div class="col-md-5" id="investment_actions">
            <h3>Actions</h3>
            <lu>
                <li><a class="btn " href="#" th:href="|@{/factors/new}?id=${investment.id}|" role="button">Add new factor</a></li>
                <li><a class="btn" href="#" th:href="|/group/newToInvestment?investmentId=${investment.id}|" role="button">Add to group</a></li>            
                <li><a class="btn" href="#" th:href="|/region/newToInvestment?investmentId=${investment.id}|" role="button">Add to region</a></li>            
                <li><a class="btn" href="#" th:href="|/risk/newToInvestment?investmentId=${investment.id}|" role="button">Add to risk</a></li>                        
                <li><a class="btn" href="#" th:href="|/investments/EditInvestment/${investment.id}|" role="button">Edit this investment</a></li> 
            </lu>
        </div>
        <div class="col-md-10">            
            <h2>Influence Factors</h2>
            <p>This investment is influenced by the following factors. </p>
            <table class="table table-hover" >
                <thead>
                    <tr>
                        <th></th>
                        <th>Name</th>
                        <th>Description</th>   
                        <th>Disassociate</th>
                    </tr>
                </thead>

                <tr th:each="factor, i: ${investment.influenceFactors}">
                    <td th:text="${i.index+1}"></td>
                    <td><a th:text="${factor.name}" th:href="|/factors/${factor.id}|"></a></td>
                    <td th:text="${factor.description}"></td>
                    <td><a href="#" th:href="|@{/factors/disassociate}/${investment.id}/${factor.id}|">Yes</a></td>
                </tr>       

            </table>
        <h2>Groups</h2>
        <p>This investment is contained within the following groups</p>
          <table class="table table-hover" >
                <thead>
                    <tr>
                        <th></th>
                        <th>Name</th>
                        <th>Description</th>   
                        <th>Disassociate</th>
                    </tr>
                </thead>

                <tr th:each="group, i : ${investment.groups}">
                    <td th:text="${i.index+1}"></td>
                    <td><a th:text="${group.name}" th:href="|/group/${group.id}|"></a></td>
                    <td th:text="${group.description}"></td>
                    <td><a href="#" th:href="|@{/group/disassociate}/${investment.id}/${group.id}|">Yes</a></td>
                </tr>                    
            </table>            

            <h2>Risks</h2>
            <p>This investment has the following risks</p>
            <table class="table table-hover" >
                <thead>
                    <tr>
                        <th></th>
                        <th>Name</th>
                        <th>Description</th>    
                        <th>Type</th>
                        <th>Disassociate</th>
                    </tr>
                </thead>

                <tr th:each="risk, i : ${investment.risks}">
                    <td th:text="${i.index+1}"></td>
                    <td><a th:text="${risk.name}" th:href="|/risk/${risk.id}|"></a></td>
                    <td th:text="${risk.description}"></td>
                    <td th:text="${risk.type}"></td>
                    <td><a href="#" th:href="|@{/risk/disassociate}/${investment.id}/${risk.id}|">Yes</a></td>
                </tr>                    
            </table>            
         <h2>Regions</h2>
         <p>This investment is in the following regions</p>
         <table class="table table-hover" >
                    <thead>
                        <tr>
                            <th></th>
                            <th>Name</th>
                            <th>Disassociate</th>
                        </tr>
                    </thead>

                    <tr th:each="region,i : ${investment.regions}">
                        <td th:text="${i.index+1}"></td>
                        <td><a th:text="${region.name}" th:href="|/region/${region.id}|"></a></td>                                
                        <td><a href="#" th:href="|@{/region/disassociate}/${investment.id}/${region.id}|">Yes</a></td>
                    </tr>                    
                </table>            
        </div>
        
       
    <script src="@{/themes/jquery.js}" th:src="@{/webjars/jquery/2.1.4/jquery.min.js}"/>
    <script th:src="@{/webjars/bootstrap/3.3.5/js/bootstrap.min.js}"/>
    <script th:src="@{/common.js}"/>
    <script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function(){
        
        /* This url might help look up funds by name
         * http://autoc.finance.yahoo.com/autoc?query=LifeStrategy%2080&region=US&lang=en&callback=YAHOO.Finance.SymbolSuggest.ssCallback
         * results:
         * YAHOO.Finance.SymbolSuggest.ssCallback({"ResultSet":{
         *  "Query":"LifeStrategy 80",
         *  "Result":[
         *      {"symbol":"GB00B4KWNF91.L","name":"Vanguard LifeStrategy 80% Equity A Inc","exch":"LSE","type":"M","exchDisp":"London","typeDisp":"Fund"},
         *      {"symbol":"GB00B4PQW151.L","name":"Vanguard LifeStrategy 80% Equity A Acc","exch":"YHD","type":"M","exchDisp":"Industry","typeDisp":"Fund"},
         *      {"symbol":"F00000MLUQ.L","name":"Vanguard LifeStrategy 80% Equity A Acc","exch":"LSE","type":"M","exchDisp":"London","typeDisp":"Fund"},
         *      {"symbol":"F00000MLUR.L","name":"Vanguard LifeStrategy 80% Equity A Inc","exch":"LSE","type":"M","exchDisp":"London","typeDisp":"Fund"}
         *      ]
         *      }
         *      }
         *      );
         */
        console.log("JQuery Ready.");
        const VANGUARD_SMALL_CAP = "IE00B3X1NT05.IR";
        const VANGUARD_LIFESTRATETY80 = "GB00B4PQW151.L";
        var symbol = VANGUARD_LIFESTRATETY80; //"[[${investment.getSymbol()}]]";

        $.getJSON( "https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.quotes%20where%20symbol%3D%22"+symbol+"%22&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=", function( data ) {        
            var r = data.query.results.quote;
            var info = {
                Name : r.Name,
              //Symbol : r.symbol,
              //PercentChange : r.Change_PercentChange,
                Change : r.Change,
              //LastTradeDate : r.LastTradeDate,
                LastTradePrice : r.LastTradePriceOnly,
                PreviousClose : r.PreviousClose,
                ChangeinPercent : r.ChangeinPercent                  
            };   
            var Currency = r.Currency;
            

            var dynamic = $("#definitions");            
            $.each( info, function( key, val ) {
              $("<dt>"+key+"</dt><dd  id='"+key+"'>"+val+"</dd>").appendTo(dynamic);
            });
            var improvedPriceStyle = { 'font-weight' : 'bold', 'color' : 'green' };    
            var worsenPriceStyle = { 'font-weight' : 'bold', 'color' : 'red' };  
            $("#Change:contains('-')").css(worsenPriceStyle);
            $("#Change:contains('+')").css(improvedPriceStyle);
            
            $("#ChangeinPercent:contains('+')").css(improvedPriceStyle);
            $("#ChangeinPercent:contains('-')").css(worsenPriceStyle);
            Currency == "GBp" ? $("#LastTradePrice,#PreviousClose").prepend("£") : $("#LastTradePrice,#PreviousClose").prepend(Currency);
            
        });
    });
    /*]]>*/
    </script>
    </body>
</html>
