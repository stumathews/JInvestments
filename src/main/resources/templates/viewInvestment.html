<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Investment Tracking</title>
        <link rel="stylesheet" th:href="@{/style.css}" />
        <link rel="stylesheet" th:href="@{/webjars/bootstrap/3.3.5/css/bootstrap.min.css}" href="bootstrap.min.css"  media="screen" />        
    </head>
    <body>        
        <div class="col-md-2">
            <div id="wrapper">               
                <div th:replace="common :: leftnav"></div>          
            </div>
        </div>
        <div class="col-md-10">
            <h1>Investment</h1>
            <table class="table table-hover" >
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Regions</th>
                            <th>Initial investment (£)</th>
                        </tr>
                    </thead>
                    
                    <td th:text="${investment.name}"></td>
                    <td th:each="region : ${investment.regions}">
                        <span th:text="${region.name}">regions</span>
                    </td>       
                    <td th:text="${investment.initialInvestment}">
                        
                    </td>                 
                </table> 
                <dl id="definitions" class="dl-horizontal">
                    <dt>Investment reason</dt>
                    <dd th:text="${investment.whyReasonStatement}">Investment reason/statement</dd>
                    <dt>Value proposition</dt>
                    <dd th:text="${investment.valueProposition}">value proposition</dd>
                    <dt>Desirability proposition</dt>
                    <dd th:text="${investment.desirabilityStatement}">desirabilityStatement</dd>
                </dl>
            <h3>Dynamic lookup</h3>
            <div id="dynamic"></div>    
            <h3>Factors</h3>
            <table class="table table-hover" >
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>   
                            <th>Disassociate</th>
                        </tr>
                    </thead>
                    
                    <tr th:each="factor : ${investment.factors}">
                        <td th:text="${factor.name}"></td>
                        <td th:text="${factor.description}"></td>
                        <td><a href="#" th:href="|@{/factors/disassociate}/${investment.id}/${factor.id}|">Yes</a></td>
                    </tr>                    
                </table> 
                <a class="btn btn-default" href="#" th:href="|@{/factors/new}?id=${investment.id}|" role="button">Add a factor</a>            
        </div>
        
       
    <script src="@{/themes/jquery.js}" th:src="@{/webjars/jquery/2.1.4/jquery.min.js}"/>
    <script th:src="@{/webjars/bootstrap/3.3.5/js/bootstrap.min.js}"/>
    <script th:src="@{/common.js}"/>
    <script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function(){
        
        /* This url might help look up funds by name
         * http://autoc.finance.yahoo.com/autoc?query=LifeStrategy%2080&region=US&lang=en&callback=YAHOO.Finance.SymbolSuggest.ssCallback
         * results:
         * YAHOO.Finance.SymbolSuggest.ssCallback({"ResultSet":{
         *  "Query":"LifeStrategy 80",
         *  "Result":[
         *      {"symbol":"GB00B4KWNF91.L","name":"Vanguard LifeStrategy 80% Equity A Inc","exch":"LSE","type":"M","exchDisp":"London","typeDisp":"Fund"},
         *      {"symbol":"GB00B4PQW151.L","name":"Vanguard LifeStrategy 80% Equity A Acc","exch":"YHD","type":"M","exchDisp":"Industry","typeDisp":"Fund"},
         *      {"symbol":"F00000MLUQ.L","name":"Vanguard LifeStrategy 80% Equity A Acc","exch":"LSE","type":"M","exchDisp":"London","typeDisp":"Fund"},
         *      {"symbol":"F00000MLUR.L","name":"Vanguard LifeStrategy 80% Equity A Inc","exch":"LSE","type":"M","exchDisp":"London","typeDisp":"Fund"}
         *      ]
         *      }
         *      }
         *      );
         */
        console.log("JQuery Ready.");
        const VANGUARD_SMALL-CAP = "IE00B3X1NT05.IR";
        const VANGUARD_LIFESTRATETY80 = "GB00B4PQW151.L"
        var symbol = "[[${investment.getSymbol()}]]";

        $.getJSON( "https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.quotes%20where%20symbol%3D%22"+symbol+"%22&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=", function( data ) {        
            var r = data.query.results.quote;
            var info = {
                Name : r.Name,
              //Symbol : r.symbol,
              //PercentChange : r.Change_PercentChange,
                Change : r.Change,
              //LastTradeDate : r.LastTradeDate,
                LastTradePrice : r.LastTradePriceOnly,
                PreviousClose : r.PreviousClose,
                ChangeinPercent : r.ChangeinPercent                  
            };   
            var Currency = r.Currency;
            

            var dynamic = $("#definitions");            
            $.each( info, function( key, val ) {
              $("<dt>"+key+"</dt><dd  id='"+key+"'>"+val+"</dd>").appendTo(dynamic);
            });
            var improvedPriceStyle = { 'font-weight' : 'bold', 'color' : 'green' };    
            var worsenPriceStyle = { 'font-weight' : 'bold', 'color' : 'red' };  
            $("#Change:contains('-')").css(worsenPriceStyle);
            $("#Change:contains('+')").css(improvedPriceStyle);
            
            $("#ChangeinPercent:contains('+')").css(improvedPriceStyle);
            $("#ChangeinPercent:contains('-')").css(worsenPriceStyle);
            Currency == "GBp" ? $("#LastTradePrice,#PreviousClose").prepend("£") : $("#LastTradePrice,#PreviousClose").prepend(Currency);
            
        });
    });
    /*]]>*/
    </script>
    </body>
</html>
