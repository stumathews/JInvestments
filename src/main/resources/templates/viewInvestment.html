<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Investment Tracking</title>
        <link rel="stylesheet" th:href="@{/style.css}" />
        <link rel="stylesheet" th:href="@{/webjars/bootstrap/3.3.5/css/bootstrap.min.css}" href="bootstrap.min.css"  media="screen" />        
    </head>
    <body>        
        <div class="col-md-2">
            <div id="wrapper">               
                <div th:replace="common :: leftnav"></div>          
            </div>
        </div>
        <div class="col-md-10">
            <h1 th:text="${investment.name}">Investment</h1>
            <p th:text="${investment.description}"></p>
            <ul class="nav nav-tabs">
                <li class="active"><a data-toggle="tab" href="#factors">Home</a></li>
                <li><a data-toggle="tab" href="#factors">Factors</a></li>
                <li><a data-toggle="tab" href="#groups">Groups</a></li>
                <li><a data-toggle="tab" href="#risks">Risks</a></li>
                <li><a data-toggle="tab" href="#regions">Regions</a></li>
            </ul>  
                
            
            <div class="tab-content">
                <div id="home" class="tab-pane fade in active">
                    <dl id="definitions" class="dl-horizontal">                    
                    <dt>Value proposition</dt>
                    <dd th:text="${investment.valueProposition}">value proposition</dd>
                    <dt>Desirability proposition</dt>
                    <dd th:text="${investment.desirabilityStatement}">desirabilityStatement</dd>                    
                    <dt>Initial investment(£)</dt>
                    <dd th:text="${investment.initialInvestment}">Initial investment</dd>
                    <dt>Value(£)</dt>
                    <dd th:text="${investment.value}">Value</dd>
                </dl>
                </div>
                <div id="factors" class="tab-pane fade"> 
                    <table class="table table-hover" >
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>   
                                    <th>Disassociate</th>
                                </tr>
                            </thead>

                            <tr th:each="factor : ${investment.influenceFactors}">
                                <td><a th:text="${factor.name}" th:href="|/factors/${factor.id}|"></a></td>
                                <td th:text="${factor.description}"></td>
                                <td><a href="#" th:href="|@{/factors/disassociate}/${investment.id}/${factor.id}|">Yes</a></td>
                            </tr>                    
                        </table>
                    <a class="btn btn-primary" href="#" th:href="|@{/factors/new}?id=${investment.id}|" role="button">Add a factor</a>            
                </div>
                <div id="groups" class="tab-pane fade">
                  <table class="table table-hover" >
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>   
                                <th>Disassociate</th>
                            </tr>
                        </thead>

                        <tr th:each="group : ${investment.groups}">
                            <td><a th:text="${group.name}" th:href="|/group/${group.id}|"></a></td>
                            <td th:text="${group.description}"></td>
                            <td><a href="#" th:href="|@{/group/disassociate}/${investment.id}/${group.id}|">Yes</a></td>
                        </tr>                    
                    </table>
                    <a class="btn btn-primary" href="#" th:href="|@{/group/new}?id=${investment.id}|" role="button">Add to group</a>            
                </div>
                <div id="risks" class="tab-pane fade">
                    <table class="table table-hover" >
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>   
                                <th>Disassociate</th>
                            </tr>
                        </thead>

                        <tr th:each="risk : ${investment.risks}">
                            <td><a th:text="${risk.name}" th:href="|/risk/${risk.id}|"></a></td>
                            <td th:text="${risk.description}"></td>
                            <td><a href="#" th:href="|@{/risk/disassociate}/${investment.id}/${risk.id}|">Yes</a></td>
                        </tr>                    
                    </table>
                    <a class="btn btn-primary" href="#" th:href="|@{/risk/new}?investmentId=${investment.id}|" role="button">Add a risk</a>            
                </div>
                <div id="regions" class="tab-pane fade">
                 <table class="table table-hover" >
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Disassociate</th>
                                </tr>
                            </thead>

                            <tr th:each="region : ${investment.regions}">
                                <td><a th:text="${region.name}" th:href="|/region/${region.id}|"></a></td>                                
                                <td><a href="#" th:href="|@{/region/disassociate}/${investment.id}/${region.id}|">Yes</a></td>
                            </tr>                    
                        </table>
                    <a class="btn btn-primary" href="#" th:href="|@{/region/new}?id=${investment.id}|" role="button">Add a region</a>               
                </div>
            </div>            
        </div>
        
       
    <script src="@{/themes/jquery.js}" th:src="@{/webjars/jquery/2.1.4/jquery.min.js}"/>
    <script th:src="@{/webjars/bootstrap/3.3.5/js/bootstrap.min.js}"/>
    <script th:src="@{/common.js}"/>
    <script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function(){
        
        /* This url might help look up funds by name
         * http://autoc.finance.yahoo.com/autoc?query=LifeStrategy%2080&region=US&lang=en&callback=YAHOO.Finance.SymbolSuggest.ssCallback
         * results:
         * YAHOO.Finance.SymbolSuggest.ssCallback({"ResultSet":{
         *  "Query":"LifeStrategy 80",
         *  "Result":[
         *      {"symbol":"GB00B4KWNF91.L","name":"Vanguard LifeStrategy 80% Equity A Inc","exch":"LSE","type":"M","exchDisp":"London","typeDisp":"Fund"},
         *      {"symbol":"GB00B4PQW151.L","name":"Vanguard LifeStrategy 80% Equity A Acc","exch":"YHD","type":"M","exchDisp":"Industry","typeDisp":"Fund"},
         *      {"symbol":"F00000MLUQ.L","name":"Vanguard LifeStrategy 80% Equity A Acc","exch":"LSE","type":"M","exchDisp":"London","typeDisp":"Fund"},
         *      {"symbol":"F00000MLUR.L","name":"Vanguard LifeStrategy 80% Equity A Inc","exch":"LSE","type":"M","exchDisp":"London","typeDisp":"Fund"}
         *      ]
         *      }
         *      }
         *      );
         */
        console.log("JQuery Ready.");
        const VANGUARD_SMALL_CAP = "IE00B3X1NT05.IR";
        const VANGUARD_LIFESTRATETY80 = "GB00B4PQW151.L";
        var symbol = VANGUARD_LIFESTRATETY80; //"[[${investment.getSymbol()}]]";

        $.getJSON( "https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.quotes%20where%20symbol%3D%22"+symbol+"%22&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=", function( data ) {        
            var r = data.query.results.quote;
            var info = {
                Name : r.Name,
              //Symbol : r.symbol,
              //PercentChange : r.Change_PercentChange,
                Change : r.Change,
              //LastTradeDate : r.LastTradeDate,
                LastTradePrice : r.LastTradePriceOnly,
                PreviousClose : r.PreviousClose,
                ChangeinPercent : r.ChangeinPercent                  
            };   
            var Currency = r.Currency;
            

            var dynamic = $("#definitions");            
            $.each( info, function( key, val ) {
              $("<dt>"+key+"</dt><dd  id='"+key+"'>"+val+"</dd>").appendTo(dynamic);
            });
            var improvedPriceStyle = { 'font-weight' : 'bold', 'color' : 'green' };    
            var worsenPriceStyle = { 'font-weight' : 'bold', 'color' : 'red' };  
            $("#Change:contains('-')").css(worsenPriceStyle);
            $("#Change:contains('+')").css(improvedPriceStyle);
            
            $("#ChangeinPercent:contains('+')").css(improvedPriceStyle);
            $("#ChangeinPercent:contains('-')").css(worsenPriceStyle);
            Currency == "GBp" ? $("#LastTradePrice,#PreviousClose").prepend("£") : $("#LastTradePrice,#PreviousClose").prepend(Currency);
            
        });
    });
    /*]]>*/
    </script>
    </body>
</html>
